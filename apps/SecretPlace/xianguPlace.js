import { plugin, verc, data, config } from '../../api/api.js';

import {
  Read_player,
  existplayer,
  isNotNull,
  sleep,
  exist_najie_thing,
  Add_najie_thing,

} from '../../model/xiuxian.js';

import {
  Add_çµçŸ³,
  Add_ä¿®ä¸º,
   Add_è¡€æ°”,
   Add_å¯¿å…ƒ,
  exist_hunyin,
  find_qinmidu,
  add_qinmidu,
  Goweizhi,
  Write_player,
  xunbaoweizhi,
  Go,
  channel,
  Read_renwu,
  Write_renwu,
  find_renwu,
} from '../../model/xiuxian.js';
import Show from "../../model/show.js";
import puppeteer from "../../../../lib/puppeteer/puppeteer.js";
export class xianguPlace extends plugin {
  constructor() {
    super({
      name: 'Yunzai_Bot_xianguPlace',
      dsc: 'ä»™å¤ç§˜å¢ƒæ¨¡å—',
      event: 'message',
      priority: 600,
      rule: [
     
       {
    reg: '^#è¿›å…¥ä»™å¤ç§˜å¢ƒ$',
    fnc: 'Goxiangu'
    }
      ],
    });
  }
async Goxiangu(e) {
  try {
    const usr_qq = e.user_id.toString().replace('qg_', '');
    const player_qq = await channel(usr_qq);
    const player = await Read_player(player_qq);

    // å¢ƒç•Œæ£€æŸ¥ - å®Œç¾ä¸–ç•Œè®¾å®š
    if (player.xiangulevel_id < 5) { // é“­æ–‡å¢ƒä»¥ä¸‹
      return e.reply([
        `ã€ä»™å¤æœªå¼€Â·å¢ƒç•Œä¸è¶³ã€‘`,
        `${player.åå·}ä»°æœ›è‹ç©¹ï¼Œæ¬²å…¥ä»™å¤ç§˜å¢ƒï¼Œ`,
        `ç„¶ç§˜å¢ƒå£å’åšå¦‚ç£çŸ³ï¼Œéé“­æ–‡å¢ƒä¸å¯æ’¼åŠ¨ï¼`,
        ``,
        `ç§˜å¢ƒè§„åˆ™ï¼š`,
        `ã€Œä»™å¤ç§˜å¢ƒä¹ƒä»™å¤çºªå…ƒç¢ç‰‡ï¼Œè•´å«æ— ä¸Šé“åˆ™ã€`,
        `å¤å²è®°è½½ï¼š`,
        `- ç§˜å¢ƒå‹åˆ¶ä¸€åˆ‡é«˜äºç¥ç«å¢ƒçš„å­˜åœ¨`,
        `- é“­æ–‡å¢ƒæ–¹å¯æ‰¿å—ç§˜å¢ƒæ³•åˆ™å¨å‹`,
        `- å¼ºé—¯è€…çš†è¢«ç§˜å¢ƒæ³•åˆ™ç¢¾ä¸ºé½‘ç²‰`,
        ``,
        `å½“å‰å¢ƒç•Œï¼š${data.xiangujinshi_list.find(l => l.level_id === player.xiangulevel_id)?.level || "æœªçŸ¥"}`,
        `è¯·å…ˆçªç ´è‡³é“­æ–‡å¢ƒå†è¯•ï¼`
      ].join('\n'));
    }
    
    if (player.xiangulevel_id > 7) { // å°Šè€…å¢ƒä»¥ä¸Š
      return e.reply([
        `ã€å¢ƒç•Œè¶…é™Â·ç§˜å¢ƒæ’æ–¥ã€‘`,
        `${player.åå·}å‘¨èº«é“åˆ™è½°é¸£ï¼Œå¨å‹éœ‡ç¢è™šç©ºï¼Œ`,
        `ç„¶ä»™å¤ç§˜å¢ƒæ³•åˆ™æ˜¾åŒ–ï¼Œå°†å…¶æ‹’ä¹‹é—¨å¤–ï¼`,
        ``,
        `ç§˜å¢ƒè§„åˆ™ï¼š`,
        `ã€Œä»™å¤ç§˜å¢ƒä¸ºå¹´è½»å¤©éª„è¯•ç‚¼ä¹‹åœ°ã€`,
        `å¤å²æ˜­ç¤ºï¼š`,
        `- å°Šè€…å¢ƒä»¥ä¸Šå¨èƒ½ä¼šç ´åç§˜å¢ƒå¹³è¡¡`,
        `- ç§˜å¢ƒæ³•åˆ™å‹åˆ¶ä¸€åˆ‡é«˜äºç¥ç«å¢ƒçš„å­˜åœ¨`,
        `- æ›¾æœ‰å¤ä»£æ€ªèƒå‹åˆ¶å¢ƒç•Œè¿›å…¥ï¼Œä»é­æ’æ–¥`,
        `- å¼ºè¡Œé—¯å…¥å°†å¼•å‘æ—¶ç©ºä¹±æµï¼Œèº«æ­»é“æ¶ˆ`,
        ``,
        `å½“å‰å¢ƒç•Œï¼š${data.xiangujinshi_list.find(l => l.level_id === player.xiangulevel_id)?.level || "æœªçŸ¥"}`,
        `è¯·å‹åˆ¶å¢ƒç•Œæˆ–å¦å¯»æœºç¼˜ï¼`
      ].join('\n'));
    }
    
    // ä½é¢æ£€æŸ¥ - å®Œç¾ä¸–ç•Œè®¾å®š
    if (player.power_place !== 2.5) { // ä¹å¤©ååœ°
      const placeNames = {
        'å‡¡é—´': 0,
        'ä»™ç•Œ': 1,
        'ä¸‹ç•Œå…«åŸŸ': 1.5,
        'é®å¤©ä½é¢': 2,
        "ä¹å¤©ååœ°": 2.5,
        'ç•Œæµ·': 3,
        'æ—¶é—´é•¿æ²³': 4,
        'æ°¸æ’æœªçŸ¥ä¹‹åœ°': 5,
        'ä»™åŸŸ': 6
      };
      
      const currentPlace = Object.entries(placeNames).find(([name, id]) => id === player.power_place)?.[0] || "æœªçŸ¥ä½é¢";
      
      return e.reply([
        `ã€æ—¶ç©ºé”™ä¹±Â·ä½é¢ä¸ç¬¦ã€‘`,
        `${player.åå·}æ¬²å…¥ä»™å¤ç§˜å¢ƒï¼Œ`,
        `å´æ„Ÿå¤©åœ°æ³•åˆ™æ’æ–¥ï¼Œæ—¶ç©ºæ‰­æ›²ï¼`,
        ``,
        `ç§˜å¢ƒè§„åˆ™ï¼š`,
        `ã€Œä»™å¤ç§˜å¢ƒåªåœ¨ä¹å¤©ååœ°ä½é¢æ˜¾ç°ã€`,
        `å¤å²è®°è½½ï¼š`,
        `- ç§˜å¢ƒå…¥å£ä½äºä¸‰åƒå·ä¸Šç©º`,
        `- å”¯æœ‰ä¹å¤©ååœ°ä¿®å£«å¯æ„Ÿåº”ç§˜å¢ƒæ³¢åŠ¨`,
        `- å¼‚åŸŸä¿®å£«æ›¾å°è¯•å¼ºè¡Œè¿›å…¥ï¼Œé­å¤©é“åå™¬`,
        `- ç§˜å¢ƒä¸ä¹å¤©ååœ°å¤§é“å…±é¸£ï¼Œä»–ç•Œéš¾å¯»`,
        ``,
        `å½“å‰ä½é¢ï¼š${currentPlace}`,
        `è¯·å…ˆå‰å¾€ä¹å¤©ååœ°ä½é¢å†å°è¯•è¿›å…¥ï¼`
      ].join('\n'));
    }
    
    // è¯»å–ä½é¢æ•°æ®
    let weimianData = {};
    try {
      const weimianPath = data.filePathMap.weimianList;
      if (fs.existsSync(weimianPath)) {
        const rawData = fs.readFileSync(weimianPath, 'utf8');
        weimianData = JSON.parse(rawData);
      } else {
        return e.reply('ä½é¢æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯ä»™å¤ç§˜å¢ƒçŠ¶æ€');
      }
    } catch (err) {
      console.error('è¯»å–ä½é¢æ•°æ®å¤±è´¥:', err);
      return e.reply('è¯»å–ä½é¢æ•°æ®å¤±è´¥ï¼Œæ— æ³•éªŒè¯ç§˜å¢ƒçŠ¶æ€');
    }
    
    // æ£€æŸ¥ç§˜å¢ƒæ˜¯å¦å¼€å¯ - å®Œç¾ä¸–ç•Œè®¾å®š
    if (weimianData.ä»™å¤ç§˜å¢ƒ !== 1) {
      return e.reply([
        `ã€ä»™å¤æœªå¼€Â·æ—¶æœºæœªè‡³ã€‘`,
        `${player.åå·}ç«‹äºä¸‰åƒå·ä¸Šç©ºï¼Œ`,
        `çœ¸å…‰å¦‚ç”µï¼Œæ¬²ç ´å¼€ç§˜å¢ƒå£å’ï¼`,
        ``,
        `ç„¶ï¼Œè™šç©ºå¯‚å¯¥ï¼Œä¸‡é“æ²‰å¯‚ï¼Œ`,
        `ç§˜å¢ƒå£å’åšå¦‚ä»™é‡‘ï¼Œçº¹ä¸ä¸åŠ¨ï¼`,
        ``,
        `ç§˜å¢ƒè§„åˆ™ï¼š`,
        `ã€Œä»™å¤ç§˜å¢ƒå¼€å¯éœ€ç­‰å¾…ä»™å¤èŠ±è•¾ç»½æ”¾ã€`,
        `å¤å²æ˜­ç¤ºï¼š`,
        `- ç§˜å¢ƒå¼€å¯éœ€ä¸‰åƒé“å·æ°”è¿æ±‡èš`,
        `- ä»™å¤èŠ±è•¾ç»½æ”¾æ—¶ï¼Œç§˜å¢ƒé—¨æˆ·æ–¹ç°`,
        `- æ—¶æœºæœªè‡³ï¼Œçºµä»™ç‹äº¦éš¾å¼ºè¡Œå¼€å¯`,
        `- å¼ºè¡Œç ´å£å°†å¼•åŠ¨çºªå…ƒåå™¬ï¼Œé“åŸºå´©æ¯`,
        ``,
        `å½“å‰çŠ¶æ€ï¼šä»™å¤èŠ±è•¾æœªç»½æ”¾`,
        `è¯·è€å¿ƒç­‰å¾…ç§˜å¢ƒè‡ªç„¶å¼€å¯ä¹‹æ—¶`
      ].join('\n'));
    }

    // æ£€æŸ¥CDæ—¶é—´ï¼ˆ12å°æ—¶ï¼‰
    const nowTime = Date.now();
    const lastEntryTime = await redis.get(`xiuxian:player:${usr_qq}:xianguCD`);
    const cooldownMs = 12 * 60 * 60 * 1000; // 12å°æ—¶
    
    if (lastEntryTime && nowTime < parseInt(lastEntryTime) + cooldownMs) {
      const remainingMs = parseInt(lastEntryTime) + cooldownMs - nowTime;
      const hours = Math.floor(remainingMs / (60 * 60 * 1000));
      const minutes = Math.floor((remainingMs % (60 * 60 * 1000)) / (60 * 1000));
      
      return e.reply([
        `ã€ç§˜å¢ƒä¼‘æ•´Â·å†·å´ä¸­ã€‘`,
        `${player.åå·}æ¬²å†å…¥ä»™å¤ç§˜å¢ƒï¼Œ`,
        `ç„¶ç§˜å¢ƒæ³•åˆ™æ’æ–¥ï¼Œéœ€ä¼‘æ•´æ¢å¤ï¼`,
        ``,
        `ç§˜å¢ƒè§„åˆ™ï¼š`,
        `ã€Œç§˜å¢ƒå†ç»ƒæ¶ˆè€—å·¨å¤§é“æºï¼Œéœ€æ—¶é—´æ¶ˆåŒ–ã€`,
        `å¤å²è®°è½½ï¼š`,
        `- ç§˜å¢ƒä¸­æ‰€å¾—æœºç¼˜éœ€æ—¶é—´ç‚¼åŒ–`,
        `- è¿ç»­è¿›å…¥å°†å¼•åŠ¨ç§˜å¢ƒæ³•åˆ™åå™¬`,
        `- æ›¾æœ‰å¤©éª„è´ªå›¾æœºç¼˜ï¼Œè¿ç»­è¿›å…¥è€Œé“åŸºå—æŸ`,
        `- ç§˜å¢ƒæ³•åˆ™é™åˆ¶ï¼ŒåäºŒæ—¶è¾°å†…ä¸å¯é‡å¤è¿›å…¥`,
        ``,
        `å‰©ä½™å†·å´æ—¶é—´ï¼š${hours}å°æ—¶${minutes}åˆ†é’Ÿ`,
        `è¯·è€å¿ƒè°ƒæ¯ï¼Œå·©å›ºæ‰€å¾—`
      ].join('\n'));
    }
    
    // æ›´æ–°CD
    await redis.set(`xiuxian:player:${usr_qq}:xianguCD`, nowTime.toString());
    
    // æ„å»ºå®Œç¾ä¸–ç•Œé£æ ¼æ–‡æ¡ˆ
    const ancientSites = [
      "çœŸé¾™å·¢ç©´",
      "ä»™è¯å›­", 
      "å¤©è§’èšåŸ‹éª¨åœ°",
      "åå‡¶ä¼ æ‰¿åœ°",
      "ä»™ç‹è®²é“å°",
      "é»‘æš—ç‰¢ç¬¼",
      "æŠ˜ä»™å’’é—è¿¹"
    ];
    const randomSite = ancientSites[Math.floor(Math.random() * ancientSites.length)];
    
    const message = [
      `ã€ä»™å¤èŠ±è•¾ç»½æ”¾Â·ç§˜å¢ƒå¼€å¯ã€‘`,
      `${player.åå·}ç«‹äºä¸‰åƒå·ä¸Šç©ºğŸŒº`,
      `ä»™å¤èŠ±è•¾ç»½æ”¾ï¼Œéœå…‰ä¸‡é“ï¼Œç‘å½©åƒæ¡ï¼`,
      `ä¸€æœµå·¨å¤§çš„èŠ±è•¾åœ¨è™šç©ºä¸­ç¼“ç¼“ç»½æ”¾ï¼Œ`,
      `æ¯ä¸€ç‰‡èŠ±ç“£éƒ½æ‰¿è½½ç€ä¸€ä¸ªæ—¶ä»£çš„æ°”è¿ï¼`,
      ``,
      `${player.åå·}åŒ–ä½œä¸€é“ä»™è™¹ï¼Œé¡ºç€ç»½æ”¾çš„èŠ±ç“£ï¼Œè¸å…¥ä»™å¤ç§˜å¢ƒï¼`,
      ``,
      `ç§˜å¢ƒå¥‡è§‚`,
      `- çœ¼å‰æµ®ç°ç ´ç¢çš„ä»™å¤çºªå…ƒæ™¯è±¡`,
      `- çœŸé¾™è™šå½±æ¨ªè´¯è‹ç©¹ï¼Œé›·å¸å®æœ¯è½°é¸£`,
      `- å¤©è§’èšåŠ›ä¹‹æå°½å¥¥ä¹‰æ˜¾åŒ–è™šç©º`,
      `- ä»™è¯èŠ¬èŠ³å¼¥æ¼«ï¼Œä¸æ­»ç‰©è´¨æµ“éƒå¦‚æ¶²`,
      `- ä»™å¤é—æ°‘åœ¨ç§˜å¢ƒä¸­ç¹è¡ç”Ÿæ¯`,
      ``,
      `ç§˜å¢ƒæœºç¼˜`,
      `ç§˜å¢ƒæ·±å¤„ï¼Œ${randomSite}æ•£å‘å‡ºè¯±äººé“éŸµï¼š`,
      `- åå‡¶å®æœ¯æ®‹ç¯‡ï¼ˆçœŸé¾™ã€é›·å¸ã€å¤©è§’èšç­‰ï¼‰`,
      `- ä»™ç‹ä¼ æ‰¿å¤ç»ï¼ˆå…­é“è½®å›ä»™ç‹ã€æ— ç»ˆä»™ç‹ç­‰ï¼‰`,
      `- å„ç§ä»™ç§ï¼ˆä¸–ç•Œæ ‘å¹¼è‹—ã€å®‡å®™é›å½¢ç§å­ç­‰ï¼‰`,
      `- ä¸æ­»ç¥è¯å¹¼è‹—ï¼ˆç™½é¾Ÿé©®ä»™ç­‰ï¼‰`,
      `- çºªå…ƒé“åˆ™ç¢ç‰‡ï¼ˆå®Œæ•´å¤§é“è§„åˆ™ï¼‰`,
      ``,
      `ç§˜å¢ƒå±é™©`,
      `ç„¶ç§˜å¢ƒä¸­äº¦å±æœºå››ä¼ï¼š`,
      `- ä»™å¤é—æ°‘æ•Œè§†å¤–æ¥è€…ï¼Œè§†å…¶ä¸ºå…¥ä¾µè€…`,
      `- é»‘æš—ç‰¢ç¬¼å¼‚åŠ¨ï¼Œä¸æœ½ä¹‹ç‹æ°”æ¯å¼¥æ¼«`,
      `- æŠ˜ä»™å’’æ®‹ç•™ï¼Œè§¦ä¹‹å³ä¼¤é“åŸº`,
      `- ç§˜å¢ƒåŸä½æ°‘ä¸­çš„å¤©ç¥ã€çœŸç¥å¼ºè€…`,
      `- å…¶ä»–å·çš„å¤©æ‰åˆä»£ã€å¤ä»£æ€ªèƒ`,
      ``,
      `${player.åå·}çœ¸å…‰åšå®šï¼Œ`,
      `"è¿™ä¸€ä¸–ï¼Œæˆ‘å½“è¸å‡ºä¸€æ¡æ— æ•Œè·¯ï¼"`,
      `èº«å½±æ²¡å…¥ç§˜å¢ƒæ·±å¤„ï¼Œå¼€å¯æ–°çš„ä¼ å¥‡...`,
      ``,
      `ã€ç§˜å¢ƒçŠ¶æ€ã€‘`,
      `ä½ç½®ï¼šä¸‰åƒå·ä¸Šç©º -> ä»™å¤ç§˜å¢ƒ`,
      `çŠ¶æ€ï¼šç§˜å¢ƒæ¢ç´¢ä¸­ï¼ˆåäºŒæ—¶è¾°å†·å´ï¼‰`,
      `æç¤ºï¼šå¯»æ‰¾é€‚åˆè‡ªå·±çš„ä»™ç§ï¼Œæˆ–ä»¥èº«ä¸ºç§ï¼`
    ].join('\n');

    // æ ‡è®°ç©å®¶è¿›å…¥ç§˜å¢ƒ
    player.in_xiangu = true;
    player.xiangu_entry_time = nowTime;
    await Write_player(player_qq, player);
    
    await e.reply(message);
    return true;

  } catch (error) {
    console.error('è¿›å…¥ä»™å¤ç§˜å¢ƒå¤±è´¥:', error);
    await e.reply([
      `è¿›å…¥ä»™å¤ç§˜å¢ƒå¤±è´¥`,
      `ç§˜å¢ƒæ³•åˆ™ç´Šä¹±ï¼Œæ—¶ç©ºé€šé“å´©æºƒï¼`,
      `é”™è¯¯ä¿¡æ¯: ${error.message}`,
      `è¯·è”ç³»ç®¡ç†å‘˜æŸ¥çœ‹æ—¥å¿—`
    ].join('\n'));
    return false;
  }
}



}
/**
* @description: è¿›åº¦æ¡æ¸²æŸ“
* @param {Number} res ç™¾åˆ†æ¯”å°æ•°
* @return {*} cssæ ·å¼
*/

async function found(A) {
  let renwu = await Read_renwu();
  let i;
  for (i = 0; i < renwu.length; i++) {
      if (renwu[i].player == A) {
          break;
      }
  }
  return i;
}

function Strand(now, max) {
  let num = (now / max * 100).toFixed(0);
  let mini
  if (num > 100) {
      mini = 100
  } else {
      mini = num
  }
  let strand = {
      style: `style=width:${mini}%`,
      num: num
  };
  return strand
}
/**
 * è®¡ç®—æ—¶é—´ç¼©å‡æ•ˆæœå¹¶ç”Ÿæˆå¯¹åº”æ¶ˆæ¯
 * @param {Object} player ç©å®¶å¯¹è±¡
 * @returns {Object} åŒ…å«æ—¶é—´ç¼©å‡å€¼å’Œæ¶ˆæ¯æ•°ç»„çš„å¯¹è±¡
 */
async function calculateTimeReduction(player) {
    let timeReduction = 0;
    const msgs = [];

    // å¤©ç’‡æ­¥æ³•æ•ˆæœ
    if (player.å­¦ä¹ çš„åŠŸæ³•.includes('å¤©ç’‡æ­¥æ³•')) {
        const tianxuanTexts = [
            `ã€å¤©ç’‡æ­¥æ³•Â·æ®‹ç¯‡å¥¥ä¹‰ã€‘`,
            `è¶³ä¸‹é“çº¹æµè½¬ï¼Œèº«å½¢å¦‚çƒŸä¼¼å¹»ï¼Œ`,
            `å¤©ç’‡æ­¥æ³•å±•åŠ¨é—´ï¼š`,
            `- ç¼©åœ°æˆå¯¸ï¼Œå±±æ²³å€’è½¬å¦‚æµ®å…‰æ å½±`,
            `- æ®‹å½±ç•™ç©ºï¼Œåæ­¥ä¹‹å¤–éš¾è¾¨çœŸèº«`,
            `"æ­¥ç½¡è¸æ–—ï¼Œå¤©ç’‡é—éŸµï¼"`,
            `æ—¶é—´å‡å°‘1åˆ†é’Ÿï¼ˆæ®‹ç¼ºç§˜æ³•ï¼Œæœªè¾¾æé€ŸçœŸè°›ï¼‰`
        ];
        timeReduction += 1;
        msgs.push(tianxuanTexts.join('\n'));
    }

    // è¡Œå­—ç§˜æ•ˆæœ
    if (player.å­¦ä¹ çš„åŠŸæ³•.includes('è¡Œå­—ç§˜')) {
        let xingziReduction = 2;
        const xingziTexts = [
            `ã€è¡Œå­—ç§˜Â·æé€Ÿå¥¥ä¹‰ã€‘`,
            `ä½ è¶³ä¸‹é“çº¹æµè½¬ï¼Œèº«å½¢å¦‚ç”µï¼Œ`,
            `æ–½å±•è¡Œå­—ç§˜ï¼Œé€Ÿåº¦éª¤å¢ï¼`,
            `è¡Œå­—ç§˜è¿è½¬é—´ï¼š`,
            `- æ­¥ä¼ç„å¦™ï¼Œç¼©åœ°æˆå¯¸`,
            `- èº«å½¢é£˜å¿½ï¼Œéš¾è§…è¸ªè¿¹`
        ];

        // æ ¹æ®å¢ƒç•Œå¢å¼ºæ•ˆæœ
        if (player.mijinglevel_id >= 9) {
            xingziReduction += 1;
            xingziTexts.push(`è„šä¸‹é‡‘è²éšç°ï¼Œé€Ÿåº¦æ›´ä¸Šä¸€å±‚`);
        }
        if (player.mijinglevel_id >= 12) {
            xingziReduction += 1;
            xingziTexts.push(`æ—¶å…‰ç¢ç‰‡ç¼­ç»•ï¼Œè§¦åŠæ—¶é—´é¢†åŸŸ`);
        }

        xingziTexts.push(
            `"å¤©ä¸‹æé€Ÿï¼Œå”¯æˆ‘è¡Œå­—ï¼"`,
            `æ—¶é—´å‡å°‘${xingziReduction}åˆ†é’Ÿ`
        );
        timeReduction += xingziReduction;
        msgs.push(xingziTexts.join('\n'));
    }

    // é“æ³•ä»™æœ¯æ•ˆæœ
    if (player.daofaxianshu == 2) {
        timeReduction += 2;
        msgs.push('å—åˆ°é“æ³•ä»™æœ¯åŠ æŒï¼Œå†ç»ƒæ—¶é—´å‡å°‘2åˆ†é’Ÿ');
    }

    return { timeReduction, msgs };
}

// æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
function formatTime(ms) {
    const minutes = Math.floor(ms / (1000 * 60));
    const seconds = Math.floor((ms % (1000 * 60)) / 1000);
    return `${minutes}åˆ†${seconds}ç§’`;
}